sequenceDiagram
  participant N as Node
  participant R as Relay

  note left of N: opening = Map { 1: { Server { alias: 1 } } }

  N->>R: listen { alias: 1, publicKey: <Buffer ...>, secretKey: <Buffer ...> }

  note right of R: servers = Map { 1: Server { alias: 2 } }

  R-->>N: listening { alias: 2, remoteAlias: 1, host: '<ip>', port: <port> }

  note left of N: servers = Map { 2: Server { alias: 1 } }

  loop
    note right of R: incoming = Map { 3: Promise { } }

    R->>N: incoming { id: 3, serverAlias: 2, remotePublicKey: <Buffer ...>, payload: <Buffer ...> }

    alt
      N-->>R: deny { id: 3 }
    else
      N-->>R: accept { id: 3 }

      note right of R: connecting = Map { 4: { Socket { alias: 4 } } }

      R->>N: connection { alias: 4, serverAlias: 2, remotePublicKey: <Buffer ...>, handshakeHash: <Buffer ...> }

      note left of N: connections = Map { 4: Socket { alias: 5 } }

      N-->>R: connected { alias: 5, remoteAlias: 4 }

      note right of R: connections = Map { 5: Socket { alias: 4 } }

      par
        loop
          N->>R: data { alias: 5, data: [<Buffer ...>] }
        end

        N->>R: end { alias: 5 }
      and
        loop
          R->>N: data { alias: 4, data: [<Buffer ...>] }
        end

        R->>N: end { alias: 4 }
      end

      alt
        N->>R: destroy { alias: 5, error: null | '<message>' }
      else
        R->>N: destroy { alias: 4, error: null | '<message>' }
      end
    end
  end

  N->>R: close { alias: 1 }

  R-->>N: closed { alias: 2 }
