sequenceDiagram
  participant N as Node
  participant R as Relay

  note left of N: opening = Map { 1: { Server { alias: 1 } } }

  N->>R: listen { alias: 1, publicKey: <Buffer ...> }

  note right of R: servers = Map { 1: Server { alias: 2 } }

  R-->>N: listening { alias: 2, remoteAlias: 1, host: '<ip>', port: <port> }

  note left of N: servers = Map { 2: Server { alias: 1 } }

  loop
    note right of R: handshakes = Map { 3: { Handshake { } } } }

    R->>N: noiseReceive { isInitiator: false, id: 3, serverAlias: 2, data: <Buffer ...> }

    note left of N: handshakes = Map { 3: { Handshake { } } }

    N-->>R: noiseReply { isInitiator: false, complete: false, id: 3, data: <Buffer ...>, remotePublicKey: <Buffer ...> }

    R->>N: noiseSend { isInitiator: false, id: 3, data: <Buffer ...> }

    N-->>R: noiseReply { isInitiator: false, complete: true, id: 4, data: <Buffer ...>, remoteId: <Buffer ...>, holepunchSecret: <Buffer ...> }

    note right of R: connecting = Map { 3: { Socket { alias: 3 } } }

    R->>N: connection { alias: 3, serverAlias: 2, remotePublicKey: <Buffer ...> }

    alt
      N-->>R: destroy { remoteAlias: 3 }
    else
      note left of N: connections = Map { 3: Socket { alias: 4 } }

      N-->>R: accept { alias: 4, remoteAlias: 3 }

      note right of R: connections = Map { 4: Socket { alias: 3 } }

      R->>N: connected { alias: 3 }
    end
  end
